name: Build VST3 (Linux + Windows)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  linux:
    name: Linux (GCC) - VST3
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build build-essential pkg-config \
            libasound2-dev libfreetype6-dev libfontconfig1-dev \
            libgl1-mesa-dev libcurl4-openssl-dev \
            libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Configure (Release)
        run: cmake -S . -B build-linux -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build-linux --config Release -j

      - name: Package artifact
        run: |
          mkdir -p artifacts/linux
          # Copy the built VST3 bundle(s)
          find build-linux -path "*_artefacts/Release/VST3/*.vst3" -maxdepth 10 -type d -print -exec cp -r {} artifacts/linux/ \;

          # Zip for convenience
          cd artifacts
          zip -r linux-vst3.zip linux

      - name: Upload artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux-vst3
          path: artifacts/linux-vst3.zip

  windows:
    name: Windows (MSVC) - VST3
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure (Release, VS2022 x64)
        run: >
          cmake -S . -B build-win
          -G "Visual Studio 17 2022"
          -A x64

      - name: Build (Release)
        run: cmake --build build-win --config Release

      - name: Package artifact
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts/windows | Out-Null

          # Copy the built VST3 bundle(s)
          $vst3Dirs = Get-ChildItem -Recurse -Directory -Path build-win | Where-Object { $_.FullName -match "_artefacts\\Release\\VST3\\.*\.vst3$" }
          foreach ($d in $vst3Dirs) { Copy-Item -Recurse -Force $d.FullName artifacts/windows/ }

          # Zip for convenience
          Compress-Archive -Path artifacts/windows -DestinationPath artifacts/windows-vst3.zip -Force

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows-vst3
          path: artifacts/windows-vst3.zip
