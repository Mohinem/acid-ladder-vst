name: Build VST3 (Linux + Windows)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  linux:
    name: Linux (GCC) - VST3
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build build-essential pkg-config \
            libasound2-dev libfreetype6-dev libfontconfig1-dev \
            libgl1-mesa-dev libcurl4-openssl-dev \
            libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Configure (Release)
        run: cmake -S . -B build-linux -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build-linux -j

      - name: Package artifact
        run: |
          set -euxo pipefail
          mkdir -p artifacts/linux

          # Copy the built VST3 bundle(s) (full directory trees)
          while IFS= read -r d; do
            cp -R "$d" artifacts/linux/
          done < <(find build-linux -type d -path "*_artefacts/Release/VST3/*.vst3")

          cd artifacts
          zip -r linux-vst3.zip linux

      - name: Upload artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux-vst3
          path: artifacts/linux-vst3.zip

  windows:
    name: Windows (MSVC) - VST3
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure (Release, VS2022 x64)
        run: >
          cmake -S . -B build-win
          -G "Visual Studio 17 2022"
          -A x64

      - name: Build (Release)
        run: cmake --build build-win --config Release

      - name: Package artifact
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path artifacts/windows | Out-Null

          # Find all VST3 bundle directories inside _artefacts/Release/VST3/
          $vst3Dirs = Get-ChildItem -Path build-win -Recurse -Directory -Filter *.vst3 |
            Where-Object { $_.FullName -match "_artefacts\\Release\\VST3\\.*\.vst3$" }

          if (-not $vst3Dirs -or $vst3Dirs.Count -eq 0) {
            Write-Error "No .vst3 bundles found under build-win/**/_artefacts/Release/VST3/"
          }

          foreach ($d in $vst3Dirs) {
            Copy-Item -Recurse -Force -Path $d.FullName -Destination "artifacts/windows/"
          }

          # âœ… Correct sanity check for VST3 on Windows:
          # The module is typically *.vst3 (a DLL with .vst3 extension) inside Contents\x86_64-win\
          $modules = Get-ChildItem -Path "artifacts/windows" -Recurse -File |
            Where-Object {
              $_.FullName -match "\\Contents\\x86_64-win\\" -and
              ( $_.Extension -ieq ".vst3" -or $_.Extension -ieq ".dll" )
            }

          if (-not $modules -or $modules.Count -eq 0) {
            Write-Error "Packaged artifact contains no VST3 module (.vst3/.dll) under Contents\\x86_64-win\\. Bundles may be incomplete."
          } else {
            Write-Host "Found VST3 module(s):"
            $modules | ForEach-Object { Write-Host " - $($_.FullName)" }
          }

          Compress-Archive -Path artifacts/windows -DestinationPath artifacts/windows-vst3.zip -Force


      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows-vst3
          path: artifacts/windows-vst3.zip
